<!DOCTYPE html>
<html>

  <head>
    <meta name="generator" content="Holy Grail Flexbox Layouter" />
    <title>Holy Grail Infinite Flexbox Scroller</title>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-slimScroll/1.3.6/jquery.slimscroll.min.js"></script>

    <script src="/js/jquery-timeago/jquery.timeago.js" type="text/javascript"></script>

    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/img/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">

    <!-->
      <link rel="import" href="/html/font-default.html">
      <link rel="import" href="/html/font-signika.html">
    </!-->
    <link rel="import" href="/html/font-roboto.html">

	  <link href="/css/flexbox-layout.css" rel="stylesheet" type="text/css">
    <link href="/css/message-boxes.css" rel="stylesheet" type="text/css">
    <link href="/css/layout-theme-dark.css" rel="stylesheet" type="text/css">


<script>
  "use strict";
  /*var EndlessModule = {
  #thread #commentlist ul li:last
  };*/
	var debugLevel = 2;

  // Realm
  var realm = "holyGrailTokenGrailholy";

	// consts
	var HTTP_STATUS_REQUESTTIMEOUT = 408;

	// global vars
	var newContentRequestRunning = false;
	var newContentRequestFinished	= false;
	var handShakeReadyForNextJson = true;
	var newContentRequestError = "";

  // user info
  var User = {
    Name: "",
    Level: 0,

  };
  // loading consts
  var LOADINGLIMIT = 2;

  var paramOffset = 0;  // where to start to get new rows
	var paramLimit = LOADINGLIMIT; // how many rows to get in one json request
	var LastSucessfullOffset = 0; // the offset used in the last request which returned rows
	var lastRecordCount = 0;  // is the number of comments returned, if 0 its probably the end of the thread
	var pageWasRefreshed = true;
  var runInterval = 0;
  var PeronalOPAlreadyRendered = false;
  var addContentTimeout = 5000;  // timeout for loading from json in milliseconds
  var loginTimeout = 5000;     // timeout for the login post

  var statusDogId = 0;  // Id of the status watchdog function interval
  var statusDogInterval = 1000;
  var autoLoadBackoff = 0; // Slow down autoload if at end of thread

	var jsonErrorCode = 0;
	var jsonErrorMessage = "";
	var jsonRenderedResult = "";
	var jsonActive = false;
  var lastRequestDuration = -1;

  if (localStorage.getItem("jsonSortByField") === "undefined") {
    localStorage.setItem("jsonSortByField", "commentcount"); // commentcount, score or postdate
  };

  var lastSucessfullOffsetCacheItem = "LastSucessfullOffsetCache";
  if (sessionStorage.getItem(lastSucessfullOffsetCacheItem) === "undefined") {
    sessionStorage.setItem(lastSucessfullOffsetCacheItem, LastSucessfullOffset);
  };

  if (debugLevel >= 2) {
    console.log("INIT sessionStorage.getItem(lastSucessfullOffsetCacheItem): " + sessionStorage.getItem(lastSucessfullOffsetCacheItem));
  };


  // DEBUG
  $(document).ready(function () {
    if (debugLevel > 2) {
      console.log("Bind Scroll button click event: " + $('#scrollclick').html());
    };
		$( "#scrollclick" ).on( "click", function() {
      // Scroll last post into view
      console.log("Click event target: " + $("#thread #commentlist ul li:last").html() );
      scrollElementIntoParentView("#thread #commentlist ul li:last", "#thread");
      console.log("Click event target: " + $("#errorsection").html() );
      scrollElementIntoParentView("#errorsection", "#thread");
    });

    $( "#cleartokenclick" ).on( "click", function() {
      console.log("Click event cleartokenclick" );
      //localStorage.setItem(realm, "");
      localStorage.removeItem(realm);
      logToDebugWindow("token has been cleared");
    });

    $( "#loadclick" ).on( "click", function(e) {
      if (isElementInView("#thread #commentlist ul li:last")) {
        if (debugLevel > 2) {
		      console.log("IN MANUAL Scroll:" + e);
        };
				// addContent(getContentTimeout
        addContent(5000);
				//addContent();
			} else {
				if (debugLevel > 2) {
          console.log("isElementInView false:" + e);
        };
			};
    });
  });
	// DEBUG END

	   function scrollElementIntoParentView(element, parent){
         try {
           $(parent)[0].scrollIntoView(false);
           $(parent).animate({ scrollTop: $(parent).scrollTop() + $(element).offset().top - $(parent).offset().top }, { duration: 2000, easing: 'linear'});
         }
         catch (err) {
         }
       };

	   // Remove all event handlers and all timeout/intervalls
	   function stopAndClearAll() {
       $( "#scrollclick" ).off( "click");
       $( "#loadclick" ).off( "click");
       $( "#thread" ).off("scroll");
       $(" #nav-sort-by-count").off("click");
       $(" #nav-sort-by-date").off("click");
       $(" #nav-sort-by-score").off("click");
       clearInterval(statusDogId);
     };

     function LoadingJsonStatus(on) {
       var loadingHiddenClass = "hidden"
       if (on == true) {
         $(".loading-icon").removeClass(loadingHiddenClass);
       } else {
         $(".loading-icon").addClass(loadingHiddenClass);
       };
     };

function JsonGetAndRenderPosts( url, limit, offset, timeout, alwaysFunc ) {

	handShakeReadyForNextJson = false;
	var uri = url + "?limit=" + limit + "&offset=" + offset;
	if (debugLevel >= 2) {
	  console.log("Start RenderComments: " + uri);
  };
	jsonActive = true;
	newContentRequestFinished = false;
	newContentRequestRunning = true;
	lastRecordCount = 0;
  lastRequestDuration = -1;

  LoadingJsonStatus(true);

  // Call JSON
  //jQuery.getJSON( uri )

  var jwtToken = localStorage.getItem(realm);
  if (debugLevel > 2) {
    console.log("Bearer: " + jwtToken);
  };

  $.ajax({
  url: uri,
  dataType: 'json',
  beforeSend: function (xhr) {
    xhr.setRequestHeader('Authorization', 'Bearer ' + jwtToken);
  },
  //data: data,
  //success: callback,
  timeout: timeout // milli second timeout
  })
    .done(function( data ) {
        //console.log( "JSON Data: " + json.users[ 3 ].name );

      $("#newjwttoken").html("New Token");

		  var commentHtml = "";
		  for (var i in data.Posts) {
            /*commentHtml += '<li><abbr class="timeago" title="' + data.Posts[i].PostDate + '">' + data.Posts[i].PostDate + '</abbr>&nbsp;--&nbsp;' +
			        '<a href="' + data.Posts[i].Url + '">' + data.Posts[i].Title + '</a>&nbsp;<a href="/t/' + data.Posts[i].Id +
					'"><img class="comment" src="/img/comment15.png" alt="Comments"> ' + data.Posts[i].CommentCount + '</a></li>';
            */
          var templateMap = {title: data.Posts[i].Title, user: data.Posts[i].User, postdate: data.Posts[i].PostDate,
                             url: data.Posts[i].Url, commentcount: data.Posts[i].CommentCount,
                             postid: data.Posts[i].Id,  score: data.Posts[i].Score};
          commentHtml += getTemplateHtml("template.singlepost", templateMap);
          PeronalOPAlreadyRendered = true;
		      lastRecordCount++;


 	    };
      LastSucessfullOffset = lastRecordCount;

		  if (debugLevel >= 2) {
		    console.log("JSON OK " + uri + " finished in " + data.RequestDuration + " ms");
		    //console.log("JSON output='" + output + "'");
		  };

      lastRequestDuration = data.RequestDuration;

		  jsonRenderedResult = commentHtml;
		  jsonActive = false;

	    newContentRequestRunning = false;
	    newContentRequestFinished = true;
		  return true;
    })
  .fail(function( jqxhr, textStatus, error ) {
    jsonErrorCode = jqxhr.status;
	  jsonErrorMessage = error;

    if (debugLevel >= 2) {
	    console.log("JSON ERROR: " + error + " textStatus: " + textStatus);
      console.log("JSON ERROR: " + jqxhr.responseJSON.Error);
	  };
    //HTTP_STATUS_REQUESTTIMEOUT
	  // Error Template
    if (error == "timeout") {
      jsonErrorCode = HTTP_STATUS_REQUESTTIMEOUT;
    } else {
    };
	  var templateMap = {errorcode: jsonErrorCode, errormessage: jsonErrorMessage + ": " + uri};
	  var errorHtml = getTemplateHtml("template.loaderror", templateMap);
	  jsonRenderedResult = errorHtml;
	  jsonActive = false;
	  newContentRequestRunning = false;
	  newContentRequestFinished = true;

    //logToDebugWindow("Fetching posts from " + uri + " failed: " + error);
    var debugMessage = "Fetching posts failed: " + jqxhr.responseJSON.Error;
    if (jqxhr.responseJSON.JwtValidationMessage != "")
    {
      debugMessage += ", " + jqxhr.responseJSON.JwtValidationMessage;
    }
    debugMessage += "(" + jqxhr.responseJSON.JwtValidationCode + ")";
    logToDebugWindow(debugMessage);

    return true;
	})
	.always(alwaysFunc);
};	// end of JsonGetAndRenderComments(


  // **** INIT Section
  $(document).ready(function () {
    // Timeago settings
    $.timeago.settings.strings.minute = "1 minute";
    $.timeago.settings.strings.hour = "a hour";
    $.timeago.settings.strings.hours = "%d hours";
    $.timeago.settings.strings.month = "a month";
    $.timeago.settings.strings.year = "a year";
    $.timeago.settings.allowFuture = true;

    // set the refresh to 30 seconds instead of 60
    // problem was that the timeago jumped from "less than a minute"
    // to "2 minutes" because of the 60 refresh
    $.timeago.settings.refreshMillis = 30000;

    // set the chronos check interval to 5 seconds instead of 50 milliseconds
    // to keep the cpu load as low as possible - it runs with 50 millis with
    // no hickups, but its just not neccessary for timeago
    chronos.minimumInterval(6000);

    var initMessage = "time: OK";

    function ResetAndRelaoad() {
      $("#thread #commentlist ul").empty();
      // global vars reset
      newContentRequestRunning = false;
      newContentRequestFinished	= false;
      handShakeReadyForNextJson = true;
      newContentRequestError = "";
      paramOffset = 0;  // where to start to get new rows
      paramLimit = LOADINGLIMIT; // how many rows to get in one json request
      LastSucessfullOffset = 0; // the offset used in the last request which returned rows
      lastRecordCount = 0;  // is the number of comments returned, if 0 its probably the end of the thread
      runInterval = 0;
      PeronalOPAlreadyRendered = false;
      addContentTimeout = 5000;  // timeout for loading from json in milliseconds
      jsonErrorCode = 0;
      jsonErrorMessage = "";
      jsonRenderedResult = "";
      jsonActive = false;
      lastRequestDuration = -1;

      sessionStorage.setItem(lastSucessfullOffsetCacheItem, LastSucessfullOffset);

      addContent(addContentTimeout);

      $("#lasttoken").html("Undefined");
    };

			// Lazy Load
      // Function called by the scroll event of the main comment list
      var ScrollEvent = function (e) {
			  if (debugLevel >= 3) {
				  console.log("ScrollEvent fired:" + e);
				};
				//addContent;
				if (isElementInView("#thread #commentlist ul li:last")) {
          if (debugLevel >= 3) {
            console.log("IN Scroll, need addContent:" + e);
          };
          // addContent getContentTimeout
          addContent(addContentTimeout);
				};
			  return true;
			};

      if (debugLevel > 3) {
        console.log("Attach scroll");
      };
			// Add scroll event
			$("#thread").on("scroll", ScrollEvent);

      // Add NAV sorting click events
      $("#nav-sort-by-count").on("click", function() {
        if (debugLevel > 1) {
          console.log("#nav-sort-by-count.on click");
        };
        setSortOrder("commentcount"); // commentcount, score or postdate
        ResetAndRelaoad();
      });
      $(" #nav-sort-by-date").on("click", function() {
        if (debugLevel > 1) {
          console.log("#nav-sort-by-date.on click");
        };
        setSortOrder("postdate"); // commentcount, score or postdate
        ResetAndRelaoad();
      });
      $(" #nav-sort-by-score").on("click", function() {
        if (debugLevel > 1) {
          console.log("#nav-sort-by-score.on click");
        };
        setSortOrder("score"); // commentcount, score or postdate
        ResetAndRelaoad();
      });
      $(" #scroll-up").on("click", function() {
        if (debugLevel > 1) {
          console.log("#scroll-up click");
        };
        scrollList("li");
      });
      $(" #scroll-down").on("click", function() {
        if (debugLevel > 1) {
          console.log("#scroll-down click");
        };
        scrollList("li:last");
      });

      // User login/logout click events
      $( "#user-login-button" ).on( "click", function() {
        if (debugLevel > 1) {
          console.log("Click event user-login-button" );
        };
        jwtlogin($("#jwt-username").val(), $("#jwt-password").val(), loginTimeout);
      });
      $("#user-logout-button").on("click", function() {
        if (debugLevel > 1) {
          console.log("#user-logout-button click");
        };
        localStorage.removeItem(realm);
        logToDebugWindow("token has been cleared");
        ShowJwtLoginInfo();
      });

      initMessage = initMessage + " events: OK";

      function scrollList(elem) {
        scrollElementIntoParentView("#thread #commentlist ul " + elem, "#thread");
      };

      function setSortOrder(order) {
        localStorage.setItem("jsonSortByField", order); // commentcount, score or postdate
        // Clearall selected buttons
        $("nav>div").removeClass("holy-batman-button-selected");
        if (order == "commentcount") {
          $("#nav-sort-by-count").addClass("holy-batman-button-selected");
        } else if (order == "postdate") {
          $("#nav-sort-by-date").addClass("holy-batman-button-selected");
        } else if (order == "score") {
          $("#nav-sort-by-score").addClass("holy-batman-button-selected");
        };
        logToDebugWindow("Changing sort to: " + order);
      };

      setSortOrder(localStorage.getItem("jsonSortByField"));

      initMessage = initMessage + " sort: " + localStorage.getItem("jsonSortByField");

      // Function called every 1 second
			statusDogId = setInterval(function(){

        if ((lastRecordCount > 0) || (autoLoadBackoff <= 0)) {
          // Check if new records should be loaded
          if (isElementInView("#thread #commentlist ul li:last")) {
            if (debugLevel > 3) {
              console.log("InView autoLoad");
            };
            //addContent(contentLoadTimeout);
            addContent(addContentTimeout);
          };// End of autoloading

          if (lastRecordCount > 0) {
            autoLoadBackoff = 0;
          } else {
            autoLoadBackoff = 10;
          };
          console.log("autoLoadBackoff " + autoLoadBackoff + " lastRecordCount " + lastRecordCount);
  			  // Show number of comments already loaded
  			  $(".commentcount").html($(".usercomment").length);
          $(".requestduration").html(lastRequestDuration);
          $(".requestresultcount").html(lastRecordCount);

          $(".lasttoken").html(localStorage.getItem(realm));

        } else {
          autoLoadBackoff--;
        };
      }, statusDogInterval);

      initMessage = initMessage + " watchdog: OK";


      var debugwindow = jQuery(".debug-window");
     debugwindow.slimScroll({
        color: '#00f',
         size: '10px',
         height: '180px',
         alwaysVisible: true,
         position: 'right',
      //    height: '15px',
         railVisible: true,
          alwaysVisible: true
        });

      logToDebugWindow(initMessage + " INIT finished");
		});
    // **** INIT Section END

		$(document).ready(function () {
      // Show Jwt info
      ShowJwtLoginInfo ();
		  // addContent getContentTimeout
			addContent(addContentTimeout);
			return true;
		});

		function isElementInView(elem) {
      var docViewTop = $(window).scrollTop();
      var docViewBottom = docViewTop + $(window).height();
      var elemNode = $(elem);
			if (typeof elemNode === "undefined") {
			  if (debugLevel >= 2) {
			    console.error("Element " + elem + " was not found in DOM");
			  };
			  return false;
			};
      if (typeof elemNode.offset() === "undefined") {
        if (debugLevel > 2) {
          console.error("Element offset() " + elem + " was not found in DOM");
        };
        return false;
      };
      var elemTop = elemNode.offset().top;
      var elemBottom = elemTop + $(elem).height();
      return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
    };

		function addContent(getContentTimeout) {

			// Check if a request is already running/outstanding
      if (newContentRequestRunning == true) {
        // Request alread running, exit!
        if (debugLevel > 0) {
          console.warn("Request alread running, exit! Offset " + paramOffset + " Timeout=" + getContentTimeout);
        };
        return false;
      };

			DumpStatusFlags(4, "START addContent");

      var runCount = 10;
			runInterval = getContentTimeout/runCount;
			var runIntervalLoops = 0;
			var timeoutID = 0;
			var watchDogId = 0;

			// Function to check if the JSON request has delivered, is self restarting each runInterval msecs
			var jsonWatchDog = function() {

					  DumpStatusFlags(3, "START watchdogFunc");

					  runIntervalLoops++;
					  if (newContentRequestFinished == true) {

  						DumpStatusFlags(3, "********* WATCHDOG DETECTED JSON FINISH!!!!");
  						newContentRequestFinished = false;
  						return true;
  					};
					  runCount--;
					  if (runCount <= 0) {

						clearTimeout(timeoutID);
						newContentRequestError = "Request Timeout Error: Was waiting for: " + (runInterval*runIntervalLoops) + " msecs";

						// Error Template
						var templateMap = {errorcode: HTTP_STATUS_REQUESTTIMEOUT, errormessage: newContentRequestError};
						var errorHtml = getTemplateHtml("template.loaderror", templateMap);

						$("#thread").append(errorHtml);

						scrollElementIntoParentView("#errorsection", "#thread");

					  };
					  // Watchdog if request is still running
					  if (newContentRequestRunning == true) {
			             watchDogId = setTimeout(jsonWatchDog, runInterval);
					  };
					  DumpStatusFlags(4, "END watchdogFunc");
			}; //End of watchdog

			// Start self restarting Watchdog to check if a request is still running
			//jsonWatchDog();

			// JsonAlways Callback - this event gets called if the json request finished - error or not
      var jsonAlwaysFunc = function( ) {

        DumpStatusFlags(4, "START jsonAlwaysFunc");

        if (jsonErrorCode == 0) {
          // if no error
          if (debugLevel > 2) {
            console.log("JSON FINISHED SUCCESSFUL, next params are: active="+ jsonActive + " paramOffset=" + paramOffset + ", paramLimit=" + paramLimit);
          };
          // Check if we got back records, if no: its the end of the thread for now
          if (lastRecordCount > 0) {
            paramOffset = parseInt(paramOffset) + parseInt(paramLimit);
            sessionStorage.setItem(lastSucessfullOffsetCacheItem, paramOffset);
          };
        } else {
          console.error("JSON Error: " + jsonErrorCode + ", Msg: " + jsonErrorMessage);
        };

        // ***** Append the new comments fetched from JSON server
		    $("#thread #commentlist ul").append(jsonRenderedResult);
		    // Convert date to timeago
        jQuery("abbr.timeago").timeago();
        jQuery("div.commenttimeago").timeago();
		    //$("#commentlist").html(jsonResult);

        newContentRequestFinished = true;
        newContentRequestRunning = false;

		    DumpStatusFlags(4, "END jsonAlwaysFunc");
			  handShakeReadyForNextJson = true;
        LoadingJsonStatus(false);

        if (pageWasRefreshed == true) {
          // Scroll last post into view
          scrollElementIntoParentView("#thread #commentlist ul li:last", "#thread");
        };
        pageWasRefreshed = false;

			  return true;
      };
			// JsonAlways Callback END
			DumpStatusFlags(4, "START JsonGetAndRenderComments");
			//JsonGetAndRenderPosts("/j/p/postdate", paramLimit, paramOffset, jsonAlwaysFunc);

      if (!(sessionStorage.getItem(lastSucessfullOffsetCacheItem) === "undefined")) {
          if (pageWasRefreshed == true) {
            LastSucessfullOffset = parseInt(sessionStorage.getItem(lastSucessfullOffsetCacheItem));
            paramOffset = 0;
            if (LastSucessfullOffset > 0) {
              paramLimit = LastSucessfullOffset;
            };
            if (debugLevel >= 2) {
              console.log("INIT SETUP LOADCACHEOFFSET, next params are: active="+ jsonActive + " paramOffset=" + paramOffset + ", paramLimit=" + paramLimit);
            };
        } else {
          paramLimit = LOADINGLIMIT;
        };
      }
      // CALL AJAX
      JsonGetAndRenderPosts("/j/p/" + localStorage.getItem("jsonSortByField"), paramLimit, paramOffset, getContentTimeout, jsonAlwaysFunc);

      DumpStatusFlags(4, "END addContent");
		};

		function getTemplateHtml(template, parameters) {
			var htmlTemplate = $(template).html();

      if (htmlTemplate == undefined) {
        console.error("getTemplateHtml: " + template + " is undefined");
        return template + " is undefined";
      }

			if (debugLevel > 3) {
			  console.log("BEFORE template " + template + ": " + htmlTemplate);
      };
			Object.keys(parameters).map(
				 function(value, index) {
					  if (debugLevel > 3) {
					    console.log( "<br>Index=" + index + ", Key=" + value + ", Data: " + parameters[value] + "<br>");
				      };
					  //errorHtml = errorHtml.replace(value, parameters[value] );
					  htmlTemplate = htmlTemplate.split("{{" + value + "}}").join( parameters[value] );

            // jQuery("abbr.timeago").timeago();
				 });
			if (debugLevel > 3) {
			  console.log("AFTER template " + template + ": " + htmlTemplate);
			};
			return htmlTemplate;
		};

    // LOGIN
    function ShowJwtLoginInfo () {
      // Get the jwt info container
      var claims =   {status: "invalid", user: -1, level: 0, expires: "N/A", issuedat: "N/A"};
      var token = localStorage.getItem(realm);
      if (token == undefined) {
        console.error("Token empty");
      } else {
        var claim = token.split(".");
        if (claim[1] === undefined) {
          console.error("Claim Undefined");
        };
        // Decode the String
        claims = jQuery.parseJSON( atob(claim[1]) );
      };

      var jwtInfo = $("#jwtinfo");
      console.log("jWT HTML: " + jwtInfo.html());
      if (jwtInfo.html() == "") {


        var templateMap = {status: "OK", user: claims.id, level: claims.UserLevel,
                           expires: (new Date(claims.exp * 1000)).toISOString(),
                           issuedat: (new Date(claims.orig_iat * 1000)).toISOString()};
        jwtInfo.html(getTemplateHtml("template.jwtinfo", templateMap));
      };

      var allJwtInfos = jwtInfo.find("div span");
      var attrId = "";
      allJwtInfos.each(function( index ) {
        console.log( index + ": " + $( this ).html() + ", attr: " + $(this).attr("id"));
        attrId = $(this).attr("id");
        if (attrId == "status") {
          $(this).text(claims.status);
        } else if (attrId == "user") {
          if (token == undefined) {
            $(this).text("unknown");
          } else {
            $(this).text(claims.user);
          };
        } else if (attrId == "level") {
          if (token == undefined) {
            $(this).addClass("hidden");
          } else {
            $(this).text(claims.level);
            $(this).removeClass("hidden");
          };
        } else if (attrId == "expires") {
          if (token == undefined) {
            $(this).timeago("dispose");
          } else {
            $(this).timeago("init");
          };
        } else if (attrId == "issuedat") {
          if (token == undefined) {
            $(this).timeago("dispose");
          } else {
            $(this).timeago("init");
          };
        };

      });
    };

    function jwtlogin(username, password, timeout) {
      if (debugLevel > 1) {
        console.log("Starting login " + username + ": " + password);
      };
      var postData = JSON.stringify({ "username": username, "password" : password });
      if (debugLevel > 1) {
        console.log("Starting login postdate: " + postData);
      };

      $.ajax({
        type: "POST",
        //the url where you want to sent the userName and password to
        url: '/login',
        contentType:"application/json",
        dataType: 'json',
        data: postData,
        //data: data,
        //success: callback,
      timeout: loginTimeout // milli second timeout
      })
        .done(function( data ) {

    		  if (debugLevel >= 2) {
    		    console.log("Login finished: " + data.token);
            $("#jwttoken").html(data.token);
    		    //console.log("JSON output='" + output + "'");
    		  };

          localStorage.setItem(realm, data.token);
          logToDebugWindow("Login for user " + username + " succeeded");



          var claim = data.token.split(".");
          if (claim[1] === undefined) {
            console.error("Claim Undefined");
          };
          // Decode the String
          var claims = jQuery.parseJSON( atob(claim[1]) );
          console.log(claims);
          console.log(claims.exp);
          console.log(claims.UserLevel);
          console.log(claims.id);
          console.log($.timeago(new Date(claims.orig_iat * 1000))  );
          //$("#newjwttoken").text($.timeago(234234))   expires: $.timeago(claims.exp)

          var templateMap = {status: "OK", user: claims.id, level: claims.UserLevel,
                             expires: (new Date(claims.exp * 1000)).toISOString(),
                             issuedat: (new Date(claims.orig_iat * 1000)).toISOString()};

          //var templaeMap = {status: "OK", user: claims.id, level: claims.UserLevel,
          //                    expires: (new Date(claims.exp * 1000)).toISOString(), issuedat: "2012-04-23T18:25:43.511Z"};

                             //Fri Sep 11 2015 04:46:33 GMT+0200 (Mitteleuropäische Sommerzeit)
          var UserHtml = getTemplateHtml("template.jwtinfo", templateMap);
          $("#jwtinfo").html(UserHtml)

          $("#issuedat").timeago();
          $("#expires").timeago();

          $("#copyLastToken").html("Copy to JWT.io");
          $("#copyLastToken").on("click", function () {
              //<a href="jwt.io?value=" + data.token>Decode</a>
              console.log("Copy to JWT clicked");
          });

          var templateMap = {user: claims.username, pass: "abc"};
          //var UserHtml = $("template.top-middle");
          //console.log( UserHtml );
          var UserHtml = getTemplateHtml("template.top-middle", templateMap);

          console.log("UserHtml: %vs", UserHtml)
          $(".top-middle").html(UserHtml);
    		  return true;
        })
        .fail(function( jqxhr, textStatus, error ) {

          if (debugLevel >= 2) {
    	       console.log("Login ERROR: " + error + " textStatus: " + textStatus);
    	      };
            //HTTP_STATUS_REQUESTTIMEOUT
    	       // Error Template
          if (error == "timeout") {
            jsonErrorCode = HTTP_STATUS_REQUESTTIMEOUT;
          } else {
          };
          $("#jwttoken").html("Login ERROR: " + error + " textStatus: " + textStatus);

          $("#lasttoken").html("Invalid");

          logToDebugWindow("Login for user '" + username + "' failed: " + error);
          return true;
    	 })
    	  .always(function( jqxhr, textStatus, error ) {
          if (debugLevel >= 2) {
    	       console.log("Login finished: " + error + " textStatus: " + textStatus);
    	    };

        });
    };
    // LOGIN END

    // REGISTER
    function jwtregister(username, password, timeout) {
      var postData = JSON.stringify({ "username": username, "password" : password });
      if (debugLevel > 2) {
        console.log("Starting register postData: " + postData);
      };

      $.ajax({
        type: "POST",
        //the url where you want to sent the userName and password to
        url: '/register',
        contentType:"application/json",
        dataType: 'json',
        data: postData,
        //data: data,
        //success: callback,
      timeout: loginTimeout // milli second timeout
      })
        .done(function( data ) {

          logToDebugWindow("Register for user " + username + " succeeded");
          if (debugLevel > 2) {
            console.log("Register return: " + data);
          };
          return true;
        })
        .fail(function( jqxhr, textStatus, error ) {

          if (debugLevel >= 2) {
             console.log("Register ERROR: " + error + " textStatus: " + textStatus);
            };
          //HTTP_STATUS_REQUESTTIMEOUT
          if (error == "timeout") {
            jsonErrorCode = HTTP_STATUS_REQUESTTIMEOUT;
            logToDebugWindow("Register for user '" + username + "' timed out ");
          } else {
          };

          logToDebugWindow("Register for user '" + username + "' failed: " + error);
          return true;
       })
        .always(function( jqxhr, textStatus, error ) {
          if (debugLevel >= 2) {
             console.log("Register finished: " + error + " textStatus: " + textStatus);
          };
        });
    };
    // REGISTER END

		//DEBUG
    function logToDebugWindow(text) {
      //$("pre.debug-window").append(text);
      var pre = jQuery("pre.debug-window");
      pre.append("<br>" + text);
      pre.scrollTop( pre.prop("scrollHeight") );
    };

		function DumpStatusFlags(level, tag) {
		  if (level <= debugLevel) {
			  console.warn("**** DUMP STATUS " + level + "/" + debugLevel + " **** " + tag);
			  console.log("newContentRequestRunning=" + newContentRequestRunning);
			  console.log("newContentRequestFinished=" + newContentRequestFinished);
			  console.log("handShakeReadyForNextJson=" + handShakeReadyForNextJson);
			  console.log("jsonActive=" + jsonActive);
			  console.log("runInterval=" + runInterval);
			  console.log("jsonErrorCode=" + jsonErrorCode + " jsonErrorMessage=" + jsonErrorMessage);
			  console.log("PARAM Offset=" + paramOffset + ", Limit=" + paramLimit + ", LastSucessfullOffset=" + LastSucessfullOffset);
			  console.log("lastRecordCount=" + lastRecordCount);
			  console.log("Start LastSucessfullOffset: " + LastSucessfullOffset);
			  console.log("PeronalOPAlreadyRendered=" + PeronalOPAlreadyRendered);
			  console.warn("** END DUMP STATUS ** " + tag);
		  };
		};


</script>

<style>

#thread {
  margin: 0;
  padding: 0;
}

#commentlist ul {
  margin: 0;
  padding: 0;
}

.userinfo {
border-style: solid;
border-width: 5px;
border-color: brown;
width: auto;
min-width: 64px;
height:auto;
min-height: 64px;
float: left;
//align: left;
margin: 5px;
padding: 1vh;
//font-size: 1vh;
//font-size: .47em;
}
.usercomment {
  //float: left;
  margin: 10px;
}
.username {
  font-size: 85%;
  padding: 0;
  margin: 0;
  width: auto;
  height:auto;
  border-style: solid;
  border-width: 1px;
  color: red;
}
.commenttimeago {
  font-size: 81%;
}
.singlecomment-wrapper {
 //float: reset;
 border-style: solid;
 border-width: 3px;
 overflow: auto;
 margin-bottom: 2vh;
}
.singlepost-wrapper {
 //float: reset;
 border-style: solid;
 border-width: 5px;
 overflow: auto;
 margin-bottom: 4vh;
}

#scroll-up, #scroll-down {
  cursor:pointer;
}

.holy-batman-button {
border:1px solid #566963;
cursor:pointer;
background-color:#3c2c2c;
color:#aaa;
margin: 2px;
padding-top: 1px;
padding-bottom: 1px;
padding-left: 10px;
padding-right: 10px;
max-height: 20px;
text-align: center;
}
.holy-batman-button:hover {
	background-color:#4c4c5c;
}
.holy-batman-button-selected {
  color:#aa0;
}

.holy-batman-input {
border:1px solid #566963;
background-color:#3c2c2c;
color:#aaa;
margin: 2px;
padding: 1px;
max-width: 8vw;
max-height: 20px;
}

.holy-batman-label {
margin: 2px;
padding-top: 2px;
padding-bottom: 2px;
padding-left: 10px;
padding-right: 10px;
text-align: center;
max-height: 20px;
}

.holy-batman-box-right {
  border-bottom:2px solid #566963;
  border-left:2px solid #566963;
  padding-top: 3px;
  padding-left: 3px;
  padding-bottom: 3px;
  font-size:0.8em;
}
footer div.debug-window {
  border:1px solid #566963;
  max-height: 50px;
  min-height: 20px;
}
.holy-batman-debug-window {
  padding: 1px;
  background: #444;
  font-family: Courier New  ;
  font-size: 11px;
	font-style: normal;
	font-variant: normal;
	font-weight: 3 0;
  min-height: 390px;
	//line-height: 23px;
}

strong.a {
  background-color:#4c4c5c;
}

.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
</style>

</head>
<body>
<div class="flexwrapper">

   <header>
     <div class="header-left">
       <img class="logo header-left" height="40px" src="img/logo.svg"></img>
       <!--<img class="logo header-left" src="img/favicon/android-icon-48x48.png"></img>
       <img class="logo header-left" src="img/favicon/test4.png"></img>
       -->
     </div>
     <div class="header-middle">
       header-middle
     </div>
     <div class="header-right">
       <div class="holy-batman-label noselect" id="user-label-name">user</div>
       <input class="holy-batman-input" id="jwt-username" title="user">
       <div class="holy-batman-label noselect" id="user-label-pass">pass</div>
       <input class="holy-batman-input" id="jwt-password" title="pass">
       &nbsp;
       <div class="holy-batman-button noselect" id="user-login-button">login</div>
       <div class="holy-batman-button noselect" id="user-logout-button">logout</div>
       <div class="holy-batman-button noselect" id="user-register-button">register</div>
     </div>
   </header>
   <main>

    <article id="thread">
<!-- <div class="error"> </div> -->
    <div id="commentlist">
	     <ul>
	      </ul>
	     </div>
    </article>
    <nav><div style="margin-bottom:8px">sort by</div>
    <div class="holy-batman-button noselect holy-batman-button-selected" id="nav-sort-by-count">count</div>
    <div class="holy-batman-button noselect" id="nav-sort-by-date">date</div>
    <div class="holy-batman-button noselect" id="nav-sort-by-score">score</div>
    <div class="noselect debug-border">
    <img Id="scroll-up" width="20px" height="20px" src="img/arrow-up.png"></img>
    scroll
    <img Id="scroll-down" width="20px" height="20px" src="img/arrow-down.png"></img>
    </div>

    </nav>
	<aside>
    <div  id="jwtinfo"></div>
    <div class="holy-batman-box-right">
      Loaded count
      <div class="commentcount">0</div>
    </div>
    <div class="holy-batman-box-right">
      Request in ms<br>
      <div class="requestduration">0</div>
    </div>
    <div class="holy-batman-box-right">
      Request result<br>
      <div class="requestresultcount">0</div>
    </div>
    <div class="holy-batman-box-right">
      Last token<br>
      <div class="holy-batman-button noselect" id="copyLastToken">copy token</div>
    </div>
  </aside>
  </main>
  <footer>
    <div class="footer-left debug-window">
      <pre class="holy-batman-debug-window debug-window">Debug window</pre>
    </div>
    <div class="footer-middle loading-icon" align="middle">
      <img src="/img/loader-pacman.gif">
    </div>
    <div class="footer-right">
      <button id="scrollclick">Scroll Error into view</button>
	  <button id="loadclick">Load test</button>
    </div>
  </footer>
</div>
<!-- End of div flexwrapper -->


<template class="top-middle">
      <div class="header-middle">You are {{number}} {{usernumber}}
      </div>
</template>

<template class="jwtinfo">
<div class="holy-batman" style="margin-bottom:5px;">jwt info:</div>
<div>status <span id="status">{{status}}</span></div>
<div>user <span id="user">{{user}}</span></div>
<div>issued <span id="issuedat" title="{{issuedat}}">{{issuedat}}</span></div>
<div>expires <span id="expires" title="{{expires}}">{{expires}}</span></div>
<div>level <span id="level">{{level}}</span></div>
</template>

<template class="loaderror">
<div id="errorsection">
<br>
<div class="error message">
 <h3>LOAD ERROR</h3>
 <h3>Status {{errorcode}}</h3>
 <p>{{errormessage}}.</p>
</div>
<br>
</div>
</template>


<template class="singlecomment">
<li>
<div class="singlecomment-wrapper" style=" border-color: blue;">
<div class="userinfo">
  <div class="username">{{user}}</div>
  <img border="1" src="http://eightbitavatar.herokuapp.com/?id={{user}}&s=female&size=64"/>
  <div class="commenttimeago" title="{{commentdate}}">{{commentdate}}</div>
</div>
<div class="usercomment">
{{body}}
</div>
</div>
</li>
</template>

<template class="singlepost">
<li>
<div class="singlepost-wrapper" style=" border-color: magenta;">
<div class="userinfo">
  <div class="username">{{user}}</div>
  <img border="2" class="avatar" src="http://eightbitavatar.herokuapp.com/?id={{user}}&s=female&size=64"/>
</div>
<div class="usercomment">
  <strong><a href="/t/{{postid}}">{{title}}</a></strong>
  <br>
  <br>
 Score {{score}}   &nbsp;  &nbsp; <abbr class="timeago" title="{{postdate}}">{{postdate}}</abbr>
  &nbsp;&nbsp;&nbsp; <a href="/t/{{postid}}">
    &nbsp;&nbsp;
    {{commentcount}}
    &nbsp;
    <img class="comment" src="/img/comment15_black.png" alt="Comments"></img></a>
  <br>
  <br>
  <a href="{{url}}">{{url}}</a>
</div>
</div>
</li>
</template>

</body>

</html>
