<!DOCTYPE html>
<html>

  <head>
    <meta name="generator" content="Holy Grail Flexbox Layouter" />
    <title>Holy Grail Infinite Flexbox Scroller</title>
	<script src="http://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>
<style>

body {
  background: LightCoral;
}
.flexwrapper {
  background: pink;
}
header {
  background: Gray;
  color: white;
}
footer {
  background: Gray;
  color: white;
}
main {
  background: yellow;
}
nav {
  background: Khaki;
}
article {
  background: LavenderBlush;
}
aside {
  background: LawnGreen;
}
</style>

<style>
body {
   margin: 0;
}
.hidden {
  visibility:hidden;
}
.visible {
  visibility:visible;
}
.flexwrapper {
  display: flex;
  flex-direction: column;
  //height: calc(100vh - 10px);
  height: 100vh;
}
header {
  order: 1;
  min-height: 30px;
  padding: 3vh;
}
footer {
  order: 3;
  min-height: 30px;
  padding: 3vh;
}
main {
  display: flex;
  flex-direction: row;
  flex-grow: 5;
  order: 2;
  flex-shrink: 5;
  flex-basis: 80%;
  justify-content: strech;
  flex-wrap: nowrap;  
}
nav {
    order: 1;
    flex-shrink: 0;
	flex-grow: 0;
	flex-basis: 10%;
	padding: 2vh;
}
article {
    order: 2;
    flex-shrink: 10;
	flex-grow: 10;
    flex-basis: 80%;
    overflow-y: scroll;
	padding: 3vh;
}
aside {
    order: 3;
    flex-shrink: 0;
	flex-grow: 0;	
    flex-basis: 10%;
	padding: 2vh;
}
</style>

<script>
       var index = 0; 
       var newContentRequest = false;
       var newContentRequestFinished = false;
       var newContentRequestError = "";	   
	   
	   $(document).ready(function () {
			// Lazy Load
			console.log("Attach scroll");
			$("#thread").scroll(function(e){
				console.log("ScrollEvent:" + e);
				//addContent();
				if (element_in_scroll("#thread ul li:last")) {
				    console.log("IN Scroll:" + e);
                    // addContent(getContentTimeout, getContentDelay)
                    addContent(5000, 20000);
					addContent();
				};
			    return true;
			});
		});
		
		$(document).ready(function () {
		    // addContent(getContentTimeout, getContentDelay)
			addContent(5000, 10);
			return true;
		});
		
		function element_in_scroll(elem) {
            var docViewTop = $(window).scrollTop();
            var docViewBottom = docViewTop + $(window).height();
 
            var elemTop = $(elem).offset().top;
            var elemBottom = elemTop + $(elem).height();
 
            return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
        };
		
		function addContent(getContentTimeout, getContentDelay) {
			// Debug fill thread
			if (newContentRequest == true) {
			   // Request alread running, exit!
               console.log(" Request alread running, exit!");			   
			   return false;
            };  
			var hiddenClass = "hidden"
			console.log("Start fill: #thread");
			
			console.log("Loading icon class: " + $(".loading-icon").attr("class"));
			$(".loading-icon").removeClass(hiddenClass);
			console.log("Loading icon class1: " + $(".loading-icon").attr("class"));
			
			newContentRequest = true;
			newContentRequestFinished = false;
			newContentRequestError = "";
			
            var runCount = 10;
			var runInterval = getContentTimeout/runCount;
			var runIntervalLoops = 0;
			var timeoutID;
			
            var intervalID = setInterval(function() { 
              runIntervalLoops++;
              if (newContentRequestFinished == true) {
                clearInterval(intervalID);
                $(".loading-icon").addClass(hiddenClass);
			    console.log("Loading icon class3: " + $(".loading-icon").attr("class"));
                newContentRequest = false;
                newContentRequestFinished = false;
              };
			  runCount--;
              if (runCount <= 0) {
                clearInterval(intervalID);
				clearTimeout(timeoutID);
				newContentRequestError = "Request Timeout Error: Was waiting for: " + (runInterval*runIntervalLoops) + " msecs";
                $("#thread").append(newContentRequestError);
				$(".loading-icon").addClass(hiddenClass);
              };
            }, runInterval);
			
			// Start Request
			timeoutID = setTimeout(function(){ 
			  var newText = "START CONTENT <ul>";
			  var addCount = index + 100;
			  while (index < addCount) {
                newText = newText + "<li>" + index + "</li>";
                index++;
              };
              newText += "</ul><br>END CONTENT<br>";
              $("#thread").append(newText);
			  console.log("Request finished");
			  newContentRequestFinished = true;
            }, getContentDelay);
			// End of Request
			
			return true;
		};

</script>		
  </head>
<body>
<div class="flexwrapper">

   <header>header</header>
   <main>

     <article id="thread">
	 Lorem   
	 </article>
     <nav> NAV </nav>
     <aside> ASIDE <br>123456</aside>
   </main>
   <footer>footer
      <div class="loading-icon hidden"  align="middle">
      <img src="/img/loader-pacman.gif">
	  </div>
   </footer>
</div> <!-- End of div flexwrapper -->
</body>

</html>
