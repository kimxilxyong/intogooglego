<!DOCTYPE html>
<html>

  <head>
    <meta name="generator" content="Holy Grail Flexbox Layouter" />
    <title>Holy Grail Infinite Flexbox Scroller</title>
	<script src="http://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>
	<script src="http://timeago.yarp.com/jquery.timeago.js" type="text/javascript"></script>
	
	<link href="/css/flexbox-layout.css" rel="stylesheet" type="text/css">
    <link href="/css/message-boxes.css" rel="stylesheet" type="text/css">
    <link href="/css/layout-theme-dark.css" rel="stylesheet" type="text/css">
    

<script>

  /*var EndlessModule = {
  #thread #commentlist ul li:last
  };*/
  var debugLevel = 3;
	   // DEBUG
       $(document).ready(function () {
	     if (debugLevel > 2) { 
	       console.log("Bind Scroll button click event: " + $('#scrollclick').html());
         };
		 $( "#scrollclick" ).on( "click", function() {
            console.log("Click event target: " + $("#errorsection").html() );
			scrollElementIntoParentView("#errorsection", "#thread");
            });		 
   
        $( "#loadclick" ).on( "click", function(e) {
			if (isElementInView("#thread #commentlist ul li:last")) {
				if (debugLevel > 2) {
				  console.log("IN MANUAL Scroll:" + e);
                };
				// addContent(getContentTimeout, getContentDelay)
                addContent(5000, 20000);
				//addContent();
			} else {
				if (debugLevel > 2) {
				  console.log("isElementInView false:" + e);
                };
			};
        });		 
	   });
	   // DEBUG END
	   
	   function scrollElementIntoParentView(element, parent){
         $(parent)[0].scrollIntoView(false);
         $(parent).animate({ scrollTop: $(parent).scrollTop() + $(element).offset().top - $(parent).offset().top }, { duration: 2000, easing: 'linear'});
       };
	   
var jsonErrorCode = 0;
var jsonErrorMessage = "";
var jsonRenderedResult = "";
var jsonActive = false;
	   
function JsonGetAndRenderComments( url, limit, offset, alwaysFunc ) {
  
    var uri = url + "?limit=" + limit + "&offset=" + offset;
	if (debugLevel > 2) {	
	  console.log("Start RenderComments: " + uri);
    };
	jsonActive = true;
    jQuery.getJSON( uri )
    .done(function( data ) {
        //console.log( "JSON Data: " + json.users[ 3 ].name );
 
		var commentHtml = "";
 
		for (var i in data.Posts) {
            /*commentHtml += '<li><abbr class="timeago" title="' + data.Posts[i].PostDate + '">' + data.Posts[i].PostDate + '</abbr>&nbsp;--&nbsp;' + 
			        '<a href="' + data.Posts[i].Url + '">' + data.Posts[i].Title + '</a>&nbsp;<a href="/t/' + data.Posts[i].Id + 
					'"><img class="comment" src="/img/comment15.png" alt="Comments"> ' + data.Posts[i].CommentCount + '</a></li>';
            */
			var templateMap = {title: data.Posts[i].Title, user: data.Posts[i].User, postdate: data.Posts[i].PostDate, url: data.Posts[i].Url};
			commentHtml += getTemplateHtml("template.singlepost", templateMap);   
		    for (var x in data.Posts[i].Comments) {
		       
			   templateMap = {body: data.Posts[i].Comments[x].Body, user: data.Posts[i].Comments[x].User};
			   commentHtml += getTemplateHtml("template.singlecomment", templateMap);
			}
        
		    //document.getElementById("commentlist").innerHTML = commentHtml;
 	    }
		     
		//console.log("Calling timeago")
		//jQuery("abbr.timeago").timeago();
		
		if (debugLevel > 2) {
		  console.log("JSON " + uri + " finished");
		  //console.log("JSON output='" + output + "'");
		};
		jsonRenderedResult = commentHtml;
		jsonActive = false;
    })
    .fail(function( jqxhr, textStatus, error ) {
      jsonErrorCode = error;
	  jsonErrorMessage = textStatus;
      if (debugLevel > 2) {
	    console.log("JSON error: " + error );
	  };
	  // Error Template
	  var templateMap = {errorcode: HTTP_STATUS_REQUESTTIMEOUT, errormessage: newContentRequestError};
	  var errorHtml = getTemplateHtml("template.loaderror", templateMap);
	  jsonRenderedResult = errorHtml;
	  jsonActive = false;
    })
	.always(alwaysFunc);
};	   


       // consts
       var HTTP_STATUS_REQUESTTIMEOUT = 408;
	   
	   // global vars
       var newContentRequest = false;
       var newContentRequestFinished = false;
       var newContentRequestError = "";	  
	   var paramOffset = 0;  // where to start to get new rows
	   var paramLimit = 2; // how many rows to get in one json request
       		
	   $(document).ready(function () {
			// Lazy Load
			if (debugLevel > 2) {
			  console.log("Attach scroll");
			};
			$("#thread").scroll(function(e){
				if (debugLevel > 3) {
				  console.log("ScrollEvent fired:" + e);
				};
				//addContent();
				if (isElementInView("#thread #commentlist ul li:last")) {
				    if (debugLevel > 3) {
					  console.log("IN Scroll, need addContent:" + e);
					};
                    // addContent(getContentTimeout, getContentDelay)
                    addContent(5000, 20000);
					//addContent();
				};
			    return true;
			});
		});
		
		$(document).ready(function () {
		    // addContent(getContentTimeout, getContentDelay)
			addContent(5000, 10);
			return true;
		});
		
		function isElementInView(elem) {
            var docViewTop = $(window).scrollTop();
            var docViewBottom = docViewTop + $(window).height();
            var elemNode = $(elem);
			if (typeof elemNode === "undefined") {
			  if (debugLevel > 2) {
			    console.error("Element " + elem + " was not found in DOM");
			  };
			  return false;
			};
            var elemTop = elemNode.offset().top;
            var elemBottom = elemTop + $(elem).height();
 
            return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
        };
		
		function addContent(getContentTimeout, getContentDelay) {
			
			// Debug fill thread
			if (newContentRequest == true) {
			   // Request alread running, exit!
			   if (debugLevel > 0) {
                 console.warn(" Request alread running, exit!");			   
               };
			   return false;
            };  
			var hiddenClass = "hidden"
			if (debugLevel > 2) {
			  console.log("addContent called with getContentTimeout=" + getContentTimeout + " getContentDelay=" + getContentDelay);
			};
			if (debugLevel > 3) {
			  console.log("Loading icon class: " + $(".loading-icon").attr("class"));
			};
			$(".loading-icon").removeClass(hiddenClass);
			if (debugLevel > 3) {
			  console.log("Loading icon class1: " + $(".loading-icon").attr("class"));
			};
			newContentRequest = true;
			newContentRequestFinished = false;
			newContentRequestError = "";
			
            var runCount = 10;
			var runInterval = getContentTimeout/runCount;
			var runIntervalLoops = 0;
			var timeoutID;
			
			// Watchdog if request is still running
			var intervalID = setInterval(function() { 
					  runIntervalLoops++;
					  if (newContentRequestFinished == true) {
						clearInterval(intervalID);
						
						$(".loading-icon").addClass(hiddenClass);
						
						if (debugLevel > 3) {
						  console.log("Loading icon class: " + $(".loading-icon").attr("class"));
						};
						newContentRequest = false;
						newContentRequestFinished = false;
					  };
					  runCount--;
					  if (runCount <= 0) {
						clearInterval(intervalID);
						clearTimeout(timeoutID);
						newContentRequestError = "Request Timeout Error: Was waiting for: " + (runInterval*runIntervalLoops) + " msecs";
						
						// Error Template
						var templateMap = {errorcode: HTTP_STATUS_REQUESTTIMEOUT, errormessage: newContentRequestError};
						var errorHtml = getTemplateHtml("template.loaderror", templateMap);
						
						$("#thread").append(errorHtml);
						
						scrollElementIntoParentView("#errorsection", "#thread");
						
						$(".loading-icon").addClass(hiddenClass);
					  };
			}, runInterval);  //End of setInterval  
			
			// Start json infinite loader
			var index = 0; 
			var testHeaderToggler = 0;
			var timeoutID = setTimeout(function(){ 
					  var addCount = index + 100;
					  
					  /*while (index < addCount) {
						if (testHeaderToggler > 0) {
						  newText = newText + "<h" + testHeaderToggler + "><li>" + index + "&nbsp Item with Header " + testHeaderToggler + "</li></h"+ testHeaderToggler +">";
						} else {
						  newText = newText + "<li>" + index + "&nbsp Standard Text" + "</li>";
						};
						index++;
						testHeaderToggler++;
						if (testHeaderToggler > 6) {
						  testHeaderToggler = 0;
						};
						
					  };*/
					  
					  
					  var jsonFinishedFunc = function( ) {
					    
					    if (jsonErrorCode == 0) {
						  // if no error
					      paramOffset += paramLimit;
						  if (debugLevel > 2) {
	                        console.log("JSON FINISHED SUCCESSFUL, next params are: active="+ jsonActive + " paramOffset=" + paramOffset + ", paramLimit=" + paramLimit); 
	                      };
					    } else {
						  console.error("JSON Error: " + jsonErrorCode + ", Msg: " + jsonErrorMessage);
						};
					  
					    $("#thread #commentlist ul").append(jsonRenderedResult);
					    jQuery("abbr.timeago").timeago();
					    //$("#commentlist").html(jsonResult);

					    newContentRequestFinished = true;
	                  };
					  
					  //newText += RenderComments("/j/t/21", paramLimit, paramOffset); 
					  
					  if (debugLevel > 2) {
	                    console.log("JSON START paramOffset=" + paramOffset + ", paramLimit=" + paramLimit); 
	                  };
					  JsonGetAndRenderComments("/j/t/21", paramLimit, paramOffset, jsonFinishedFunc); 
					  
					  return true;
					}, getContentDelay);
			// End of dummy filler
		};	
		
		function getTemplateHtml(template, parameters) {
			var htmlTemplate = $(template).html();
			
			if (debugLevel > 3) {
			  console.log("BEFORE template " + template + ": " + htmlTemplate);
            };
			Object.keys(parameters).map(
				 function(value, index) {
					  if (debugLevel > 3) {
					    console.log( "<br>Index=" + index + ", Key=" + value + ", Data: " + parameters[value] + "<br>");
				      };
					  //errorHtml = errorHtml.replace(value, parameters[value] );
					  htmlTemplate = htmlTemplate.split("{{" + value + "}}").join( parameters[value] );
				 });	
			if (debugLevel > 3) {	 
			  console.log("AFTER template " + template + ": " + htmlTemplate);
			};
			return htmlTemplate;
		};
			
		// End of Ready
		
</script>		

<style>
.userinfo {
border-style: solid;
border-width: 5px;
width: auto;
min-width: 64px;
height:auto;
min-height: 64px;
float: left;
//align: left;
margin: 10px;
padding: 1vh;
font-size: 3vh;
}
.usercomment {
  //float: left;
  margin: 10px;
}
.singlecomment-wrapper {
 //float: reset;
 border-style: solid;
 border-width: 3px;
 overflow: auto;
 margin-bottom: 2vh;
}
.singlepost-wrapper {
 //float: reset;
 border-style: solid;
 border-width: 5px;
 overflow: auto;
 margin-bottom: 4vh;
}
</style>

</head>
<body>
<div class="flexwrapper">

   <header>header is in magenta</header>
   <main>

     <article id="thread">
	 Lorem   
<!-- <div class="error"> </div> -->
    <div id="commentlist">
	<ul>
	</ul>
	</div>
    </article>
    <nav> NAV </nav>
    <aside> ASIDE
      <br>123456</aside>
  </main>
  <footer>
    <div class="footer-left">footer
    </div>
    <div class="footer-middle loading-icon" align="middle">
      <img src="/img/loader-pacman.gif">
    </div>
    <div class="footer-right">
      <button id="scrollclick">Scroll Error into view</button>
	  <button id="loadclick">Load test</button>
    </div>
  </footer>
</div>
<!-- End of div flexwrapper -->


<template class="loaderror">
<div id="errorsection">
<br>
<div class="error message">
 <h3>LOAD ERROR CODE {{errorcode}}</h3>
 <p>{{errormessage}}.</p>
  <h3>Status {{errorcode}}</h3>
 <p>Message: {{errormessage}}.</p>
</div>
<br>
</div>
</template>


<template class="singlecomment">
<li>
<div class="singlecomment-wrapper" style=" border-color: blue;">
<div class="userinfo">{{user}}</div>
<div class="usercomment">
{{body}}
</div>
</div>
</li>
</template>

<template class="singlepost">
<li>
<div class="singlepost-wrapper" style=" border-color: magenta;">
<div class="userinfo">{{user}}</div>
<div class="usercomment">

<abbr class="timeago" title="{{postdate}}">{{postdate}}</abbr>
&nbsp
<a href="{{url}}">{{url}}</a>
<br><br>
{{title}}
<br>

</div>
</div>
</li>
</template>

</body>

</html>
