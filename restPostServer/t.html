<!DOCTYPE html>
<html>

  <head>
    <meta name="generator" content="Holy Grail Flexbox Layouter" />
    <title>Holy Grail Infinite Flexbox Scroller</title>
	<script src="http://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>
	<script src="http://timeago.yarp.com/jquery.timeago.js" type="text/javascript"></script>
	
	<link href="/css/flexbox-layout.css" rel="stylesheet" type="text/css">
    <link href="/css/message-boxes.css" rel="stylesheet" type="text/css">
    <link href="/css/layout-theme-dark.css" rel="stylesheet" type="text/css">
    

<script>
  "use strict";
  /*var EndlessModule = {
  #thread #commentlist ul li:last
  };*/
	var debugLevel = 3;
	// consts
	var HTTP_STATUS_REQUESTTIMEOUT = 408;

	// global vars
	var newContentRequestRunning = false;
	var newContentRequestFinished	= false;
	var handShakeReadyForNextJson = true;
	var newContentRequestError = "";	  
	var paramOffset = 0;  // where to start to get new rows
	var paramLimit = 2; // how many rows to get in one json request
	var LastSucessfullOffset = 0; // the offset used in the last request which returned rows
	var lastRecordCount = 0;  // is the number of comments returned, if 0 its probably the end of the thread
	var runInterval = 0;
    var PeronalOPAlreadyRendered = false;	
    var statusDogId = 0;  // Id of the status watchdog function interval
	
	var jsonErrorCode = 0;
	var jsonErrorMessage = "";
	var jsonRenderedResult = "";
	var jsonActive = false;

     // DEBUG
       $(document).ready(function () {
	     if (debugLevel > 2) { 
	       console.log("Bind Scroll button click event: " + $('#scrollclick').html());
         };
		 $( "#scrollclick" ).on( "click", function() {
            console.log("Click event target: " + $("#errorsection").html() );
			scrollElementIntoParentView("#errorsection", "#thread");
            });		 
   
        $( "#loadclick" ).on( "click", function(e) {
			if (isElementInView("#thread #commentlist ul li:last")) {
				if (debugLevel > 2) {
				  console.log("IN MANUAL Scroll:" + e);
                };
				// addContent(getContentTimeout, getContentDelay)
                addContent(5000, 20000);
				//addContent();
			} else {
				if (debugLevel > 2) {
				  console.log("isElementInView false:" + e);
                };
			};
        });		 
	   });
	   // DEBUG END
	   
	   function scrollElementIntoParentView(element, parent){
         $(parent)[0].scrollIntoView(false);
         $(parent).animate({ scrollTop: $(parent).scrollTop() + $(element).offset().top - $(parent).offset().top }, { duration: 2000, easing: 'linear'});
       };
	   
	   // Remove all event handlers and all timeout/intervalls
	   function stopAndClearAll() {
	     $( "#scrollclick" ).off( "click");
		 $( "#loadclick" ).off( "click");
		 $("#thread").off("scroll");
		 clearInterval(statusDogId);
		 
	   };
	   
	   
function JsonGetAndRenderComments( url, limit, offset, alwaysFunc ) {
	
	handShakeReadyForNextJson = false;
	var uri = url + "?limit=" + limit + "&offset=" + offset;
	if (debugLevel > 2) {	
	  console.log("Start RenderComments: " + uri);
    };
	jsonActive = true;
	newContentRequestFinished = false;
	newContentRequestRunning = false;
	lastRecordCount = 0;
	
	if (offset > 0) {
	  if (LastSucessfullOffset >= offset) {
	   console.error("Terminating LastSucessfullOffset: " + LastSucessfullOffset + ", new offset: " + offset);
	   DumpStatusFlags(3, "****JsonGetAndRenderComments terminated!!!");
	   jsonActive = false;
	   newContentRequestFinished = true;
	   newContentRequestRunning = false;
	   return false;
	  };
    };
    jQuery.getJSON( uri )
    .done(function( data ) {
        //console.log( "JSON Data: " + json.users[ 3 ].name );
 
		var commentHtml = "";
	    ;
		for (var i in data.Posts) {
            /*commentHtml += '<li><abbr class="timeago" title="' + data.Posts[i].PostDate + '">' + data.Posts[i].PostDate + '</abbr>&nbsp;--&nbsp;' + 
			        '<a href="' + data.Posts[i].Url + '">' + data.Posts[i].Title + '</a>&nbsp;<a href="/t/' + data.Posts[i].Id + 
					'"><img class="comment" src="/img/comment15.png" alt="Comments"> ' + data.Posts[i].CommentCount + '</a></li>';
            */
			if (PeronalOPAlreadyRendered == false) {
			   var templateMap = {title: data.Posts[i].Title, user: data.Posts[i].User, postdate: data.Posts[i].PostDate, url: data.Posts[i].Url};
			   commentHtml += getTemplateHtml("template.singlepost", templateMap);   
		       PeronalOPAlreadyRendered = true;
			};
			for (var x in data.Posts[i].Comments) {
		       lastRecordCount++;
			   templateMap = {body: data.Posts[i].Comments[x].Body, user: data.Posts[i].Comments[x].User};
			   commentHtml += getTemplateHtml("template.singlecomment", templateMap);
			};
			LastSucessfullOffset = offset;
			
 	    };

		
		if (debugLevel > 2) {
		  console.log("JSON OK " + uri + " finished");
		  //console.log("JSON output='" + output + "'");
		};
		jsonRenderedResult = commentHtml;
		jsonActive = false;
		  
	    newContentRequestRunning = false;
	    newContentRequestFinished = true;
		return true;
    })
    .fail(function( jqxhr, textStatus, error ) {
      jsonErrorCode = error;
	  jsonErrorMessage = textStatus;
      if (debugLevel > 2) {
	    console.log("JSON ERROR: " + error );
	  };
	  // Error Template
	  var templateMap = {errorcode: HTTP_STATUS_REQUESTTIMEOUT, errormessage: newContentRequestError};
	  var errorHtml = getTemplateHtml("template.loaderror", templateMap);
	  jsonRenderedResult = errorHtml;
	  jsonActive = false;
	  newContentRequestRunning = false;
	  newContentRequestFinished = true;
      return true;
	})
	.always(alwaysFunc);
};	// end of JsonGetAndRenderComments(   
			
	   $(document).ready(function () {
			// Lazy Load
			if (debugLevel > 2) {
			  console.log("Attach scroll");
			};
			// Add scroll event
			//$("#thread").scroll(function(e){
            $("#thread").on("scroll", function(e){			
			  if (debugLevel > 3) {
				  console.log("ScrollEvent fired:" + e);
				};
				//addContent();
				if (isElementInView("#thread #commentlist ul li:last")) {
				    if (debugLevel > 3) {
					  console.log("IN Scroll, need addContent:" + e);
					};
                    // addContent(getContentTimeout, getContentDelay)
                    addContent(5000, 20000);
					//addContent();
				};
			    return true;
			});
			
			statusDogId = setInterval(function(){
			  // Show number of comments already loaded 
			  $(".commentcount").html($(".usercomment").length);
            }, 1000);			
			
		});
		
		$(document).ready(function () {
		    // addContent(getContentTimeout, getContentDelay)
			addContent(5000, 10);
			return true;
		});
		
		function isElementInView(elem) {
            var docViewTop = $(window).scrollTop();
            var docViewBottom = docViewTop + $(window).height();
            var elemNode = $(elem);
			if (typeof elemNode === "undefined") {
			  if (debugLevel > 2) {
			    console.error("Element " + elem + " was not found in DOM");
			  };
			  return false;
			};
            var elemTop = elemNode.offset().top;
            var elemBottom = elemTop + $(elem).height();
 
            return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
        };
		
		function addContent(getContentTimeout, getContentDelay) {
			
			// Check if a request is already running/outstanding
			if (newContentRequestRunning == true) {
			   // Request alread running, exit!
			   if (debugLevel > 0) {
                 console.warn("!! Request alread running, exit! Timeout=" + getContentTimeout + " Delay=" + getContentDelay);			   
               };
			   return false;
            };  
			
			DumpStatusFlags(4, "START addContent");
			
			var hiddenClass = "hidden"
			if (debugLevel > 2) {
			  console.log("addContent called with Timeout=" + getContentTimeout + " Delay=" + getContentDelay);
			};
			if (debugLevel > 3) {
			  console.log("Loading icon class=" + $(".loading-icon").attr("class"));
			};
			$(".loading-icon").removeClass(hiddenClass);
			if (debugLevel > 3) {
			  console.log("Loading icon classafter showing=" + $(".loading-icon").attr("class"));
			};
			
			
            var runCount = 10;
			runInterval = getContentTimeout/runCount;
			var runIntervalLoops = 0;
			var timeoutID = 0;
			var watchDogId = 0;
			
			// Function to check if the JSON request has delivered, is self restarting each runInterval msecs
			var jsonWatchDog = function() { 
					  
					  DumpStatusFlags(3, "START watchdogFunc");
					  
					  runIntervalLoops++;
					  if (newContentRequestFinished == true) {
				
						$(".loading-icon").addClass(hiddenClass);
						
						if (debugLevel > 3) {
						  console.log("Loading icon class: " + $(".loading-icon").attr("class"));
						};
						
						DumpStatusFlags(3, "********* WATCHDOG DETECTED JSON FINISH!!!!");
						newContentRequestFinished = false;
						return true;
					  };
					  runCount--;
					  if (runCount <= 0) {
						
						clearTimeout(timeoutID);
						newContentRequestError = "Request Timeout Error: Was waiting for: " + (runInterval*runIntervalLoops) + " msecs";
						
						// Error Template
						var templateMap = {errorcode: HTTP_STATUS_REQUESTTIMEOUT, errormessage: newContentRequestError};
						var errorHtml = getTemplateHtml("template.loaderror", templateMap);
						
						$("#thread").append(errorHtml);
						
						scrollElementIntoParentView("#errorsection", "#thread");
						
						$(".loading-icon").addClass(hiddenClass);
					  };
					  // Watchdog if request is still running
					  if (newContentRequestRunning == true) {
			             watchDogId = setTimeout(jsonWatchDog, runInterval);
					  };
					  DumpStatusFlags(4, "END watchdogFunc");
			}; //End of watchdog  
			
			// Start self restarting Watchdog to check if a request is still running
			jsonWatchDog();
				
			// JsonAlways Callback
						var jsonAlwaysFunc = function( ) {
					    
						DumpStatusFlags(4, "START jsonAlwaysFunc");
						
					    if (jsonErrorCode == 0) {
						  // if no error
						  if (debugLevel > 2) {
	                        console.log("JSON FINISHED SUCCESSFUL, next params are: active="+ jsonActive + " paramOffset=" + paramOffset + ", paramLimit=" + paramLimit); 
	                      };
						  // Check if we got back records, if no: its the end of the thread for now
						  if (lastRecordCount > 0) {
						    paramOffset += paramLimit;
						  };
					    } else {
						  console.error("JSON Error: " + jsonErrorCode + ", Msg: " + jsonErrorMessage);
						};
					  
					    $("#thread #commentlist ul").append(jsonRenderedResult);
					    jQuery("abbr.timeago").timeago();
					    //$("#commentlist").html(jsonResult);

					    newContentRequestFinished = true;
						newContentRequestRunning = false;
	                  
					    DumpStatusFlags(4, "END jsonAlwaysFunc");
						handShakeReadyForNextJson = true;
						return true;
					  };
			// JsonAlways Callback END
			DumpStatusFlags(4, "START JsonGetAndRenderComments"); 	
			JsonGetAndRenderComments("/j/t/21", paramLimit, paramOffset, jsonAlwaysFunc); 
					  
			DumpStatusFlags(4, "END addContent");
		};	
		
		function getTemplateHtml(template, parameters) {
			var htmlTemplate = $(template).html();
			
			if (debugLevel > 3) {
			  console.log("BEFORE template " + template + ": " + htmlTemplate);
            };
			Object.keys(parameters).map(
				 function(value, index) {
					  if (debugLevel > 3) {
					    console.log( "<br>Index=" + index + ", Key=" + value + ", Data: " + parameters[value] + "<br>");
				      };
					  //errorHtml = errorHtml.replace(value, parameters[value] );
					  htmlTemplate = htmlTemplate.split("{{" + value + "}}").join( parameters[value] );
				 });	
			if (debugLevel > 3) {	 
			  console.log("AFTER template " + template + ": " + htmlTemplate);
			};
			return htmlTemplate;
		};
		
		//DEBUG
		function DumpStatusFlags(level, tag) {
		  if (level <= debugLevel) { 
			  console.warn("**** DUMP STATUS **** " + tag);
			  console.log("newContentRequestRunning=" + newContentRequestRunning);
			  console.log("newContentRequestFinished=" + newContentRequestFinished);
			  console.log("handShakeReadyForNextJson=" + handShakeReadyForNextJson);
			  console.log("jsonActive=" + jsonActive);
			  console.log("runInterval=" + runInterval);
			  console.log("jsonErrorCode=" + jsonErrorCode + " jsonErrorMessage=" + jsonErrorMessage);
			  console.log("PARAM Offset=" + paramOffset + ", Limit=" + paramLimit + ", LastSucessfullOffset=" + LastSucessfullOffset); 
			  console.log("lastRecordCount=" + lastRecordCount);
			  console.log("Start LastSucessfullOffset: " + LastSucessfullOffset);
			  console.log("PeronalOPAlreadyRendered=" + PeronalOPAlreadyRendered);
			  console.warn("** END DUMP STATUS ** " + tag);
		  };
		};
			
		// End of Ready
		
</script>		

<style>

#thread {
  margin: 0;
  padding: 0;
}

#commentlist ul {
  margin: 0;
  padding: 0;
}

.userinfo {
border-style: solid;
border-width: 5px;
width: auto;
min-width: 64px;
height:auto;
min-height: 64px;
float: left;
//align: left;
margin: 5px;
padding: 1vh;
font-size: 3vh;
}
.usercomment {
  //float: left;
  margin: 10px;
}
.singlecomment-wrapper {
 //float: reset;
 border-style: solid;
 border-width: 3px;
 overflow: auto;
 margin-bottom: 2vh;
}
.singlepost-wrapper {
 //float: reset;
 border-style: solid;
 border-width: 5px;
 overflow: auto;
 margin-bottom: 4vh;
}
</style>

</head>
<body>
<div class="flexwrapper">

   <header>header is in magenta</header>
   <main>

     <article id="thread">
	 Lorem   
<!-- <div class="error"> </div> -->
    <div id="commentlist">
	<ul>
	</ul>
	</div>
    </article>
    <nav> NAV CommentCount
	  <div class="commentcount">0</div>
    </nav>
	<aside> ASIDE
      <br>123456</aside>
  </main>
  <footer>
    <div class="footer-left">footer
    </div>
    <div class="footer-middle loading-icon" align="middle">
      <img src="/img/loader-pacman.gif">
    </div>
    <div class="footer-right">
      <button id="scrollclick">Scroll Error into view</button>
	  <button id="loadclick">Load test</button>
    </div>
  </footer>
</div>
<!-- End of div flexwrapper -->


<template class="loaderror">
<div id="errorsection">
<br>
<div class="error message">
 <h3>LOAD ERROR CODE {{errorcode}}</h3>
 <p>{{errormessage}}.</p>
  <h3>Status {{errorcode}}</h3>
 <p>Message: {{errormessage}}.</p>
</div>
<br>
</div>
</template>


<template class="singlecomment">
<li>
<div class="singlecomment-wrapper" style=" border-color: blue;">
<div class="userinfo">{{user}}
<br><img src="http://eightbitavatar.herokuapp.com/?id={{user}}&s=female&size=64"/></div>
<div class="usercomment">
{{body}}
</div>
</div>
</li>
</template>

<template class="singlepost">
<li>
<div class="singlepost-wrapper" style=" border-color: magenta;">
<div class="userinfo">{{user}}
<br><img src="http://eightbitavatar.herokuapp.com/?id={{user}}&s=female&size=64"/></div>
<div class="usercomment">

<abbr class="timeago" title="{{postdate}}">{{postdate}}</abbr>
&nbsp
<a href="{{url}}">{{url}}</a>
<br><br>
{{title}}
<br>

</div>
</div>
</li>
</template>

</body>

</html>
